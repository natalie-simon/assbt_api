name: Deploy NestJS to OVH VPS (Production)

on:
  push:
    branches:
      - production
    paths-ignore:
      - '**.md'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:  # permet de d√©clencher manuellement

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Ajouter une √©tape pour v√©rifier le contenu du d√©p√¥t
      - name: Check repository content
        run: |
          echo "Contenu du d√©p√¥t GitHub:"
          ls -la
          echo "V√©rification du fichier docker-compose.prod.yml:"
          if [ -f "docker-compose.prod.yml" ]; then
            echo "‚úÖ Fichier docker-compose.prod.yml trouv√© dans le d√©p√¥t"
            cat docker-compose.prod.yml | head -n 10
          else
            echo "‚ùå Fichier docker-compose.prod.yml NON trouv√© dans le d√©p√¥t"
            find . -name "docker-compose*.yml" -type f
          fi

      # Nouvelle approche: utiliser scp pour transf√©rer directement les fichiers
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY_OVH }}
          known_hosts: 'placeholder-to-avoid-errors'
          if_key_exists: replace

      - name: Add host to known_hosts
        run: ssh-keyscan -p 2222 ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Copy docker-compose file directly
        if: ${{ success() }}
        run: |
          if [ -f "docker-compose.prod.yml" ]; then
            scp -P 2222 docker-compose.prod.yml deploy@${{ secrets.VPS_HOST }}:/home/deploy/app/nestjs/
            echo "‚úÖ Fichier docker-compose.prod.yml transf√©r√© avec scp"
          else
            echo "‚ùå Impossible de transf√©rer le fichier, il n'existe pas localement"
          fi

      - name: Deploy to OVH VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY_OVH }}
          port: 2222
          script: |
            # D√©finition du r√©pertoire racine sur le VPS
            VPS_ROOT="/home/deploy/app"
            APP_DIR="${VPS_ROOT}/nestjs"

            # S'assurer que le r√©pertoire d'application existe
            mkdir -p ${APP_DIR}

            # V√©rifier l'√©tat actuel
            echo "üìÇ Contenu actuel du r√©pertoire de d√©ploiement:"
            ls -la ${APP_DIR}

            # Sauvegarde de la base de donn√©es si elle est en cours d'ex√©cution
            if [ -f "${APP_DIR}/docker-compose.prod.yml" ]; then
              cd ${APP_DIR}
              if docker-compose -f docker-compose.prod.yml ps postgres 2>&1 | grep -q "Up"; then
                echo "üì¶ Sauvegarde de la base de donn√©es..."
                mkdir -p ${APP_DIR}/backups
                docker-compose -f docker-compose.prod.yml exec -T postgres pg_dump -U postgres nestjs_db > ${APP_DIR}/backups/db_$(date +"%Y%m%d_%H%M%S").sql || echo "‚ö†Ô∏è √âchec de sauvegarde, poursuite du d√©ploiement"
              fi
            fi

            # Pr√©server les fichiers importants
            cd ${APP_DIR}
            if [ -f "${APP_DIR}/.env" ]; then
              echo "üíæ Sauvegarde du fichier .env actuel"
              cp ${APP_DIR}/.env ${APP_DIR}/.env.backup
            fi

            # Nettoyer le r√©pertoire mais pr√©server certains dossiers/fichiers et docker-compose.prod.yml
            echo "üßπ Nettoyage du r√©pertoire de d√©ploiement..."
            find ${APP_DIR} -mindepth 1 -not -path "${APP_DIR}/backups*" -not -name ".env" -not -name ".env.backup" -not -name "docker-compose.prod.yml" -exec rm -rf {} \; 2>/dev/null || true

            # Copier les fichiers du projet depuis le d√©p√¥t GitHub
            echo "üìã Copie des fichiers du projet..."
            cd /tmp/github-actions-runner/_work/${{ github.repository }}/${{ github.repository }}
            tar cf - --exclude='.git' --exclude='node_modules' . | (cd ${APP_DIR} && tar xf -)

            # V√©rifier si docker-compose.prod.yml existe dans le r√©pertoire d'application
            if [ ! -f "${APP_DIR}/docker-compose.prod.yml" ]; then
              echo "‚ö†Ô∏è docker-compose.prod.yml n'a pas √©t√© trouv√© apr√®s la copie des fichiers"
              # Rechercher le fichier dans le workspace GitHub Actions
              find /tmp/github-actions-runner/_work -name "docker-compose.prod.yml" 2>/dev/null
            else
              echo "‚úÖ Fichier docker-compose.prod.yml trouv√© √† ${APP_DIR}/docker-compose.prod.yml"
            fi

            # Gestion du fichier .env
            if [ ! -f "${APP_DIR}/.env" ]; then
              echo "üîç Fichier .env non trouv√©, recherche d'alternatives..."

              # V√©rifier si .env.backup existe
              if [ -f "${APP_DIR}/.env.backup" ]; then
                echo "‚úÖ Restauration du fichier .env.backup"
                cp ${APP_DIR}/.env.backup ${APP_DIR}/.env
              # V√©rifier si .env.prod existe dans le r√©pertoire racine
              elif [ -f "${VPS_ROOT}/.env.prod" ]; then
                echo "‚úÖ Copie du fichier .env.prod depuis ${VPS_ROOT}"
                cp ${VPS_ROOT}/.env.prod ${APP_DIR}/.env
              else
                echo "‚ö†Ô∏è Aucun fichier .env trouv√©! Le d√©ploiement pourrait √©chouer."
              fi
            fi

            # Afficher le contenu du r√©pertoire apr√®s la copie
            echo "üìÇ Contenu du r√©pertoire apr√®s copie:"
            ls -la ${APP_DIR}

            # V√©rifier que docker-compose.prod.yml existe
            if [ ! -f "${APP_DIR}/docker-compose.prod.yml" ]; then
              echo "‚ùå Fichier docker-compose.prod.yml non trouv√©!"
              exit 1
            fi

            # D√©ployer l'application
            cd ${APP_DIR}
            echo "üöÄ D√©ploiement de l'application..."
            docker-compose -f docker-compose.prod.yml down || true
            docker-compose -f docker-compose.prod.yml up -d --build

            # Attendre que les services soient pr√™ts
            echo "‚è≥ Attente du d√©marrage des services..."
            sleep 30

            # V√©rifier l'√©tat des services
            echo "üìä √âtat des services apr√®s d√©ploiement:"
            docker-compose -f docker-compose.prod.yml ps

            # Ex√©cuter les migrations TypeORM
            if docker-compose -f docker-compose.prod.yml ps | grep -q "api"; then
              echo "üîÑ Ex√©cution des migrations TypeORM..."
              docker-compose -f docker-compose.prod.yml exec -T api npm run migration:run || echo "‚ö†Ô∏è √âchec des migrations"
            else
              echo "‚ö†Ô∏è Le container api n'est pas en cours d'ex√©cution, migrations ignor√©es"
            fi

            # Afficher les logs Docker
            echo "üìÉ Logs des containers:"
            docker ps

            # Nettoyage
            echo "üßπ Nettoyage des images inutilis√©es..."
            docker image prune -f