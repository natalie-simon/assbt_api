name: Deploy NestJS to OVH VPS (Production)

on:
  push:
    branches:
      - production
    paths-ignore:
      - '**.md'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:  # permet de d√©clencher manuellement

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to OVH VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY_OVH }}
          port: 2222  # ou votre port SSH personnalis√©
          script: |
            # D√©finition du r√©pertoire racine sur le VPS
            VPS_ROOT="/home/deploy/app"
            APP_DIR="${VPS_ROOT}/nestjs"

            # S'assurer que le r√©pertoire d'application existe
            mkdir -p ${APP_DIR}

            # V√©rifier l'√©tat actuel
            echo "üìÇ Contenu actuel du r√©pertoire de d√©ploiement:"
            ls -la ${APP_DIR}

            # Sauvegarde de la base de donn√©es si elle est en cours d'ex√©cution
            if [ -f "${APP_DIR}/docker-compose.prod.yml" ]; then
              cd ${APP_DIR}
              if docker-compose -f docker-compose.prod.yml ps postgres 2>&1 | grep -q "Up"; then
                echo "üì¶ Sauvegarde de la base de donn√©es..."
                mkdir -p ${APP_DIR}/backups
                docker-compose -f docker-compose.prod.yml exec -T postgres pg_dump -U postgres nestjs_db > ${APP_DIR}/backups/db_$(date +"%Y%m%d_%H%M%S").sql || echo "‚ö†Ô∏è √âchec de sauvegarde, poursuite du d√©ploiement"
              fi
            fi

            # Pr√©server les fichiers importants
            cd ${APP_DIR}
            if [ -f "${APP_DIR}/.env" ]; then
              echo "üíæ Sauvegarde du fichier .env actuel"
              cp ${APP_DIR}/.env ${APP_DIR}/.env.backup
            fi

            # Nettoyer le r√©pertoire mais pr√©server certains dossiers/fichiers
            echo "üßπ Nettoyage du r√©pertoire de d√©ploiement..."
            find ${APP_DIR} -mindepth 1 -not -path "${APP_DIR}/backups*" -not -name ".env" -not -name ".env.backup" -not -name "docker-compose.prod.yml" -exec rm -rf {} \; 2>/dev/null || true

            # Copier les fichiers du projet depuis le d√©p√¥t GitHub
            echo "üìã Copie des fichiers du projet..."
            #cd /tmp/github-actions-runner/_work/${{ github.repository }}/${{ github.repository }}
            cd /tmp/github-actions-runner/_work/*/*
            tar cf - --exclude='.git' --exclude='node_modules' . | (cd ${APP_DIR} && tar xf -)

            # Gestion du fichier .env
            if [ ! -f "${APP_DIR}/.env" ]; then
              echo "üîç Fichier .env non trouv√©, recherche d'alternatives..."

              # V√©rifier si .env.backup existe
              if [ -f "${APP_DIR}/.env.backup" ]; then
                echo "‚úÖ Restauration du fichier .env.backup"
                cp ${APP_DIR}/.env.backup ${APP_DIR}/.env
              # V√©rifier si .env.prod existe dans le r√©pertoire racine
              elif [ -f "${VPS_ROOT}/.env.prod" ]; then
                echo "‚úÖ Copie du fichier .env.prod depuis ${VPS_ROOT}"
                cp ${VPS_ROOT}/.env.prod ${APP_DIR}/.env
              else
                echo "‚ö†Ô∏è Aucun fichier .env trouv√©! Le d√©ploiement pourrait √©chouer."
              fi
            fi

            # V√©rifier le contenu apr√®s la copie
            echo "üìÇ Contenu du r√©pertoire apr√®s copie:"
            ls -la ${APP_DIR}

            # V√©rifier que docker-compose.prod.yml existe
            if [ ! -f "${APP_DIR}/docker-compose.prod.yml" ]; then
              echo "‚ùå Fichier docker-compose.prod.yml non trouv√©!"
              exit 1
            fi

            # D√©ployer l'application
            cd ${APP_DIR}
            echo "üöÄ D√©ploiement de l'application..."
            docker-compose -f docker-compose.prod.yml down || true
            docker-compose -f docker-compose.prod.yml up -d --build

            # Attendre que les services soient pr√™ts
            echo "‚è≥ Attente du d√©marrage des services..."
            sleep 30

            # V√©rifier l'√©tat des services
            echo "üìä √âtat des services apr√®s d√©ploiement:"
            docker-compose -f docker-compose.prod.yml ps

            # Ex√©cuter les migrations TypeORM
            if docker-compose -f docker-compose.prod.yml ps | grep -q "api"; then
              echo "üîÑ Ex√©cution des migrations TypeORM..."
              docker-compose -f docker-compose.prod.yml exec -T api npm run migration:run || echo "‚ö†Ô∏è √âchec des migrations"
            else
              echo "‚ö†Ô∏è Le container api n'est pas en cours d'ex√©cution, migrations ignor√©es"
            fi

            # Afficher les logs Docker
            echo "üìÉ Logs des containers:"
            docker ps

            # Nettoyage
            echo "üßπ Nettoyage des images inutilis√©es..."
            docker image prune -f
